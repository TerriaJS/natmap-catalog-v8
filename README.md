# V8 National Map Catalog !

## How to build

```
node .\natmap\build.js
```

Catalog will be saved to `./out.json`

## To update catalog

1. Run `catalog-converter` on nationalmap/aremi catalog
2. Copy input (v7) and output (v8) to `natmap\in` and rename to match naming patterns:
  - `natmap\in\natmap-2020-09-03.json`
  - `natmap\in\natmap-2020-09-03-v8.json`
  
### AREMI catalog

Currently, there are manual modifications to v8 AREMI catalog:

- Untouched v8 JSON generated by `catalog-converter`: `natmap\in\aremi-2020-09-22-v8.json`
- v8 JSON with manual modifications `natmap\in\aremi-2020-09-22-v8-with-mods.json`

This approach is not ideal, but will let you see changes using a diff-tool. These changes should be made with JavaScript.
 
**Note:** `natmap/root.js` uses `natmap\in\aremi-2020-09-22-v8-with-mods.json`. So manual modifications are only needed when you update AREMI catalog.
  
### Add new datasets from GA
`National Datasets` are added 9 datasets as described by `catalog` in file `./natmap/in/manual-v8-catalogs/ga-new-layers-v8.json`. You can directly drag-and-drop this
json file to the NationalMap to verify if they work correctly. Each member in the `catalog` array has a property `catalogPath` that tells `root.js` where to add this
member.

### Generate a complete catalog json file
Run

```
  node natmap/build.js
```

which will produce catalog file `natmap/out.json`. Please upload this file to the `s3` bucket with different name to be used by national map config.

The following commands will compress the content of `natmap/out.json` then upload it to `s3://static.nationalmap.nicta.com.au/init/2021-09-30.json` as a catalogue for https://nationalmap.gov.au.

```
  aws sso login --profile nationalmap
  chmod +x publish.sh 
  ./publish.sh 2021-09-30
```

**Catalogue history (in `s3://static.nationalmap.nicta.com.au/init)**
| *s3 file name* | *commit version* |
|----------------|------------------|
| natmap-2021-02-10-v8.json | 9c1194b45b7e77df7e40efd9aae94e86a97e95f6 |
| natmap-2021-03-30-v8.json | 92f0b1744aa77eb8be9e894a775f27fabc98f873 |
| natmap-2021-04-13-v8.json | 5a5e99f5acc92907381dbcdd256e5a0490225f59 |
| natmap-2021-04-14-v8.json | 128bf155564c009ff091b84efd8445271e1e8289 |
| natmap-2021-04-16-v8.json | 3bd209bebcf2446715ea131ed4e52a5faf825dc5 |
| natmap-2021-04-16-v8.json | 3bd209bebcf2446715ea131ed4e52a5faf825dc5 |
| natmap-2021-05-12-v8.json | d9b4efd2c28ca4135b9a6dccad9ac52e7eb6d1b5 |
| 2021-09-30.json | 0f26e8e8f0ee8fc54ef4522eb0f5e44baca38e5b |

**Catalogue history (in GitHub)**
| *catalog commit* | *this repo commit* |
|----------------|------------------|
| https://github.com/TerriaJS/saas-catalogs-public/commit/facb398ba31cf9b68ccfb92a227a566b6592555f | https://github.com/TerriaJS/natmap-catalog-v8/commit/061b2cbcbebd1fae24cfda0cf60f5886a57b0cda |

## Deploy
 
**UPDATE** catalogs are now stored in https://github.com/TerriaJS/saas-catalogs-public/tree/main/nationalmap:

- https://raw.githubusercontent.com/TerriaJS/saas-catalogs-public/main/nationalmap/dev.json
- https://raw.githubusercontent.com/TerriaJS/saas-catalogs-public/main/nationalmap/test.json
- https://raw.githubusercontent.com/TerriaJS/saas-catalogs-public/main/nationalmap/prod.json
 
 To deploy: 
 1. Update files in https://github.com/TerriaJS/saas-catalogs-public/tree/main/nationalmap
 2. Update URL in `initializationUrls` in SaaS `map-config`  
    - **Dev:** https://dev.saas.terria.io/record-editor/map-config-nationalmap
    - **Test:** https://test.saas.terria.io/record-editor/map-config-nationalmap
    - **Prod:** https://saas.terria.io/record-editor/map-config-nationalmap
 3. Manually update map-config.json files in https://github.com/TerriaJS/saas-catalogs-public
